{% extends "admin_base.html" %}

{% block title %}管理介面 - 吉他社管理系統{% endblock %}

{% block content %}
<style>
/* 自訂租借記錄顏色 - 深色背景 */
.rental-record {
    background-color: #762E1A !important; 
    color: white !important; /* 白色文字 */
}

/* 確保租借記錄中的 badge 在深色背景下可見 */
.rental-record .badge {
    border: 1px solid rgba(255,255,255,0.3);
}

/* 器材圖片樣式 */
.equipment-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.equipment-image-placeholder {
    width: 50px;
    height: 50px;
    background-color: #f8f9fa;
    border: 1px dashed #ddd;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 12px;
}

.image-upload-preview {
    max-width: 150px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-top: 10px;
}
</style>

<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog"></i> 管理介面</h2>
        
        <!-- 統計資訊 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>總會員數</h5>
                        <h3>{{ members|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>未歸還器材</h5>
                        <h3>{{ unreturned|sum(attribute=4) }}</h3>
                        <small>{{ unreturned|length }} 個項目</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>總租借次數</h5>
                        <h3>{{ all_rentals|length }}</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 導航標籤 -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                    <i class="fas fa-boxes"></i> 器材庫存
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="unreturned-tab" data-bs-toggle="tab" data-bs-target="#unreturned" type="button" role="tab">
                    <i class="fas fa-exclamation-triangle"></i> 未歸還器材
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
                    <i class="fas fa-users"></i> 會員管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">
                    <i class="fas fa-history"></i> 租借記錄
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="adminTabContent">
            <!-- 器材庫存 -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <div class="row">
                    <!-- 庫存狀況 -->
                    <div class="col-lg-8">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-boxes"></i> 器材庫存狀況</h5>
                            </div>
                            <div class="card-body">
                                {% if equipment_status %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>圖片</th>
                                                <th>器材類型</th>
                                                <th>型號</th>
                                                <th>總數量</th>
                                                <th>可借數量</th>
                                                <th>已借出</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in equipment_status %}
                                            <tr>
                                                <td>
                                                    {% if item[7] %}
                                                        <img src="{{ item[7] }}" class="equipment-image" 
                                                             alt="{{ item[2] }}" 
                                                             onclick="showImageModal('{{ item[6] or item[7] }}', '{{ item[2] }}')"
                                                             style="cursor: pointer;"
                                                             onerror="this.parentElement.innerHTML='<div class=equipment-image-placeholder>無圖片</div>'">
                                                    {% else %}
                                                        <div class="equipment-image-placeholder">無圖片</div>
                                                    {% endif %}
                                                </td>
                                                <td>{{ item[1] }}</td>
                                                <td>{{ item[2] }}</td>
                                                <td>
                                                    <form method="POST" action="{{ url_for('update_equipment') }}" class="d-inline" enctype="multipart/form-data">
                                                        <input type="hidden" name="equipment_id" value="{{ item[0] }}">
                                                        <div class="input-group input-group-sm" style="width: 120px;">
                                                            <input type="number" class="form-control" name="total_quantity" 
                                                                   value="{{ item[3] }}" min="1" max="99">
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                                    onclick="toggleImageUpload({{ item[0] }})" title="上傳圖片">
                                                                <i class="fas fa-camera"></i>
                                                            </button>
                                                            <button type="submit" class="btn btn-outline-primary btn-sm" 
                                                                    onclick="return confirm('確定要修改數量嗎？')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        </div>
                                                        <div id="imageUpload{{ item[0] }}" class="mt-2" style="display: none;">
                                                            <input type="file" class="form-control form-control-sm" 
                                                                   name="equipment_image" accept="image/*"
                                                                   onchange="previewImage(this, {{ item[0] }})">
                                                            <div id="imagePreview{{ item[0] }}"></div>
                                                        </div>
                                                    </form>
                                                </td>
                                                <td>{{ item[4] }}</td>
                                                <td>{{ item[5] }}</td>
                                                <td>
                                                    {% if item[4] == 0 %}
                                                        <span class="badge bg-danger">已借完</span>
                                                    {% elif item[4] <= item[3] * 0.3 %}
                                                        <span class="badge bg-warning">庫存不足</span>
                                                    {% else %}
                                                        <span class="badge bg-success">充足</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('delete_equipment', equipment_id=item[0]) }}" 
                                                       class="btn btn-outline-danger btn-sm" 
                                                       onclick="return confirm('確定要刪除此器材嗎？如有未歸還記錄將無法刪除。')">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted">暫無器材資料</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 新增器材 -->
                    <div class="col-lg-4">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus"></i> 新增器材</h6>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('add_equipment') }}" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="category" class="form-label">器材類型</label>
                                        <input type="text" class="form-control" id="category" name="category" 
                                               placeholder="例：插電吉他" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="model" class="form-label">型號</label>
                                        <input type="text" class="form-control" id="model" name="model" 
                                               placeholder="例：Fender Telecaster" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="total_quantity" class="form-label">數量</label>
                                        <input type="number" class="form-control" id="total_quantity" name="total_quantity" 
                                               min="1" max="99" value="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="equipment_image" class="form-label">器材圖片</label>
                                        <input type="file" class="form-control" id="equipment_image" name="equipment_image" 
                                               accept="image/*" onchange="previewNewImage(this)">
                                        <div class="form-text">支援 JPG, PNG 格式，檔案大小不超過 5MB</div>
                                        <div id="newImagePreview"></div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> 新增器材
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- 操作說明 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> 操作說明</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-edit text-primary"></i> 直接修改總數量並點擊 ✓</li>
                                    <li><i class="fas fa-camera text-info"></i> 點擊相機圖示上傳圖片</li>
                                    <li><i class="fas fa-plus text-success"></i> 右側表單新增器材</li>
                                    <li><i class="fas fa-image text-warning"></i> 點擊圖片可放大檢視</li>
                                    <li><i class="fas fa-trash text-danger"></i> 刪除器材（需無借用記錄）</li>
                                    <li><i class="fas fa-exclamation-triangle text-warning"></i> 總數量不能小於已借出數量</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 未歸還器材 -->
            <div class="tab-pane fade" id="unreturned" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle text-warning"></i> 未歸還器材</h5>
                        <span class="badge bg-warning text-dark">{{ unreturned|length }}  個項目</span>
                    </div>
                    <div class="card-body">
                        {% if unreturned %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>借用人</th>
                                        <th>學號</th>
                                        <th>器材類型</th>
                                        <th>型號</th>
                                        <th>未歸還數量</th>
                                        <th>最早租借時間</th>
                                        <th>預計歸還日期</th>
                                        <th>狀態</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in unreturned %}
                                    <tr>
                                        <td>{{ item[0] }}</td>
                                        <td>{{ item[1] }}</td>
                                        <td>{{ item[2] }}</td>
                                        <td>{{ item[3] }}</td>
                                        <td>
                                            <span class="badge bg-warning text-dark">{{ item[4] }} 件</span>
                                        </td>
                                        <td>{{ item[5] }}</td>
                                        <td>
                                            {% if item[8] %}
                                                {{ item[8] }}
                                                {% if item[7] %}
                                                    <small class="text-muted d-block">({{ item[7] }} 天)</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">未設定</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item[8] %}
                                                <span class="badge overdue-badge" 
                                                      data-expected-date="{{ item[8] }}" 
                                                      data-rental-time="{{ item[5] }}">計算中...</span>
                                            {% else %}
                                                <span class="badge bg-secondary">無預期日期</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">目前沒有未歸還的器材</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 會員管理 -->
            <div class="tab-pane fade" id="members" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users"></i> 註冊會員列表</h5>
                    </div>
                    <div class="card-body">
                        {% if members %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>學號</th>
                                        <th>姓名</th>
                                        <th>班級</th>
                                        <th>社團身分</th>
                                        <th>註冊時間</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member in members %}
                                    <tr>
                                        <td>{{ member[1] }}</td>
                                        <td>{{ member[2] }}</td>
                                        <td>{{ member[3] }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ member[4] }}</span>
                                        </td>
                                        <td>{{ member[5] }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal"
                                                        data-user-id="{{ member[0] }}"
                                                        data-student-id="{{ member[1] }}"
                                                        data-user-name="{{ member[2] }}">
                                                    <i class="fas fa-key"></i> 重設密碼
                                                </button>
                                                <span style="display:inline-block; width:32px;"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteUserModal"
                                                        data-user-id="{{ member[0] }}"
                                                        data-student-id="{{ member[1] }}"
                                                        data-user-name="{{ member[2] }}"
                                                        data-class-name="{{ member[3] }}"
                                                        data-club-role="{{ member[4] }}">
                                                    <i class="fas fa-trash"></i> 刪除
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">暫無註冊會員</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 租借記錄 -->
            <div class="tab-pane fade" id="records" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> 所有租借記錄</h5>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('export_excel') }}" class="btn btn-success btn-sm">
                                <i class="fas fa-file-excel"></i> 匯出 Excel
                            </a>
                            <button type="button" class="btn btn-danger btn-sm ms-2" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#clearRecordsModal">
                                <i class="fas fa-trash-alt"></i> 清空記錄
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if all_rentals %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>記錄說明：</strong>深色背景為初始租借記錄，白色背景為歸還記錄。
                            清空記錄功能會刪除所有租借歷史並重置器材庫存。
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>借用人</th>
                                        <th>學號</th>
                                        <th>器材類型</th>
                                        <th>型號</th>
                                        <th>數量</th>
                                        <th>租借時間</th>
                                        <th>歸還時間</th>
                                        <th>狀態</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in all_rentals %}
                                    <tr {% if record[7] == 'rental' %}class="rental-record"{% endif %}>
                                        <td>{% if record[7] == 'rental' %}
                                            {{ record[0] }}
                                            {% endif %}
                                        </td>
                                        <td>{% if record[7] == 'rental' %}
                                            {{ record[1] }}
                                            {% endif %}
                                        </td>
                                        <td>{{ record[2] }}</td>
                                        <td>{{ record[3] }}</td>
                                        <td>{{ record[6] }} 件</td>
                                        <td>{{ record[4] }}</td>
                                        <td>
                                            {% if record[7] == 'rental' %}
                                                初始租借
                                            {% elif record[5] %}
                                                {{ record[5] }}
                                            {% else %}
                                                未歸還
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record[7] == 'rental' %}
                                                {% if record[9] > 0 %}
                                                    <span class="badge bg-success">租借中 (共{{ record[8] }}件)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">已全部歸還</span>
                                                {% endif %}
                                            {% elif record[9] > 0 %}
                                                <span class="badge bg-danger">剩餘{{ record[9] }}件未還</span>
                                            {% else %}
                                                
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">暫無租借記錄</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 清空租借記錄確認對話框 -->
<div class="modal fade" id="clearRecordsModal" tabindex="-1" aria-labelledby="clearRecordsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearRecordsModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 危險操作：清空所有租借記錄
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('clear_all_records') }}">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-skull-crossbones"></i>
                        <strong>⚠️ 危險操作 ⚠️</strong><br>
                        此操作將會<strong>永久刪除</strong>所有租借記錄，無法復原！
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">📋 此操作將會：</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li>❌ <strong>刪除所有租借記錄</strong> (包含歷史記錄)</li>
                                <li>❌ <strong>刪除所有歸還記錄</strong></li>
                                <li>🔄 <strong>重置所有器材庫存</strong> (設為最大可借數量)</li>
                                <li>✅ <strong>保留所有用戶資料</strong></li>
                                <li>✅ <strong>保留所有器材資料</strong></li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label for="confirmationText" class="form-label">
                            <strong>安全確認：</strong>請輸入「<span class="text-danger">清空所有記錄</span>」來確認操作
                        </label>
                        <input type="text" class="form-control" name="confirmation_text" id="confirmationText" 
                               placeholder="請完全按照要求輸入確認文字" required>
                        <div class="form-text">
                            必須完全一致才能執行操作，大小寫和標點符號都要正確
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="finalConfirmation" required>
                        <label class="form-check-label" for="finalConfirmation">
                            我了解此操作的後果，並確認要執行清空記錄操作
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-danger" id="clearRecordsBtn" disabled>
                        <i class="fas fa-trash-alt"></i> 確認清空所有記錄
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 清空記錄確認邏輯
document.addEventListener('DOMContentLoaded', function() {
    const confirmationText = document.getElementById('confirmationText');
    const finalConfirmation = document.getElementById('finalConfirmation');
    const clearBtn = document.getElementById('clearRecordsBtn');
    
    function validateClearForm() {
        const textCorrect = confirmationText.value === '清空所有記錄';
        const checkboxChecked = finalConfirmation.checked;
        
        clearBtn.disabled = !(textCorrect && checkboxChecked);
        
        // 視覺回饋
        if (confirmationText.value && !textCorrect) {
            confirmationText.classList.add('is-invalid');
        } else {
            confirmationText.classList.remove('is-invalid');
        }
    }
    
    confirmationText.addEventListener('input', validateClearForm);
    finalConfirmation.addEventListener('change', validateClearForm);
    
    // 重置表單當模態對話框關閉時
    const clearModal = document.getElementById('clearRecordsModal');
    clearModal.addEventListener('hidden.bs.modal', function() {
        confirmationText.value = '';
        finalConfirmation.checked = false;
        confirmationText.classList.remove('is-invalid');
        clearBtn.disabled = true;
    });
});
</script>

<!-- 圖片檢視模態對話框 -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">器材圖片</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="器材圖片" style="max-height: 500px;">
            </div>
        </div>
    </div>
</div>

<!-- 重設密碼模態對話框 -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="fas fa-key"></i> 重設用戶密碼
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('reset_user_password') }}">
                <div class="modal-body">
                    <input type="hidden" name="user_id" id="modalUserId">
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>注意：</strong>重設密碼後，該用戶需要使用新密碼重新登入。
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">用戶資訊</label>
                        <div class="card">
                            <div class="card-body">
                                <h6 id="userInfo" class="mb-1"></h6>
                                <small class="text-muted">學號：<span id="studentIdInfo"></span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">新密碼</label>
                        <input type="password" class="form-control" name="new_password" id="newPassword" 
                               placeholder="請輸入新密碼" minlength="4" required>
                        <div class="form-text">密碼長度至少4個字元</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">確認新密碼</label>
                        <input type="password" class="form-control" id="confirmNewPassword" 
                               placeholder="請再次輸入新密碼" minlength="4" required>
                        <div class="invalid-feedback" id="passwordMismatch" style="display: none;">
                            密碼確認不符
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning" id="resetPasswordBtn" disabled>
                        <i class="fas fa-key"></i> 確認重設密碼
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 刪除用戶模態對話框 -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 刪除社員
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>警告：此操作無法復原！</strong>
                </div>
                
                <p>您確定要刪除以下社員嗎？</p>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-2" id="deleteUserName"></h6>
                        <div class="row">
                            <div class="col-sm-4"><strong>學號：</strong></div>
                            <div class="col-sm-8" id="deleteStudentId"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>班級：</strong></div>
                            <div class="col-sm-8" id="deleteClassName"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>社團身分：</strong></div>
                            <div class="col-sm-8"><span class="badge bg-info" id="deleteClubRole"></span></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>注意事項：</h6>
                    <ul class="small text-muted">
                        <li>如果該社員有未歸還的器材，將無法刪除</li>
                        <li>刪除後該社員的歷史租借記錄會保留作為追蹤</li>
                        <li>該社員將無法再登入系統</li>
                        <li>此操作無法復原</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <a id="confirmDeleteBtn" href="#" class="btn btn-danger">
                    <i class="fas fa-trash"></i> 確認刪除
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// 圖片相關功能
function showImageModal(imageUrl, equipmentName) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModalLabel').textContent = `器材圖片 - ${equipmentName}`;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function toggleImageUpload(equipmentId) {
    const uploadDiv = document.getElementById(`imageUpload${equipmentId}`);
    if (uploadDiv.style.display === 'none') {
        uploadDiv.style.display = 'block';
    } else {
        uploadDiv.style.display = 'none';
    }
}

function previewImage(input, equipmentId) {
    const previewDiv = document.getElementById(`imagePreview${equipmentId}`);
    previewDiv.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // 檢查檔案大小 (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('檔案大小不能超過 5MB');
            input.value = '';
            return;
        }
        
        // 檢查檔案類型
        if (!file.type.startsWith('image/')) {
            alert('請選擇圖片檔案');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-upload-preview';
            previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewNewImage(input) {
    const previewDiv = document.getElementById('newImagePreview');
    previewDiv.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // 檢查檔案大小 (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('檔案大小不能超過 5MB');
            input.value = '';
            return;
        }
        
        // 檢查檔案類型
        if (!file.type.startsWith('image/')) {
            alert('請選擇圖片檔案');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-upload-preview';
            previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

// 計算借用天數和逾期狀態
document.addEventListener('DOMContentLoaded', function() {
    // 處理逾期狀態計算
    const overdueBadges = document.querySelectorAll('.overdue-badge');
    overdueBadges.forEach(badge => {
        const expectedDate = badge.getAttribute('data-expected-date');
        const rentalTime = badge.getAttribute('data-rental-time');
        
        if (expectedDate) {
            // 使用更精確的時間解析
            const now = new Date();
            
            // 解析預計歸還時間（格式：YYYY-MM-DD HH:MM）
            let expected;
            if (expectedDate.includes(' ')) {
                // 包含時間的格式
                expected = new Date(expectedDate.replace(' ', 'T') + ':00+08:00'); // 明確指定台灣時區
            } else {
                // 只有日期的格式，設為當天23:59
                expected = new Date(expectedDate + 'T23:59:59+08:00');
            }
            
            // 解析租借時間
            const rental = new Date(rentalTime.replace(' ', 'T') + '+08:00');
            
            // 計算已借用時間（以小時為單位，更精確）
            const borrowedHours = Math.floor((now - rental) / (1000 * 60 * 60));
            const borrowedDays = Math.floor(borrowedHours / 24);
            
            console.log('Debug info:', {
                now: now.toISOString(),
                expected: expected.toISOString(), 
                rental: rental.toISOString(),
                borrowedHours: borrowedHours,
                timeDiff: now - expected
            });
            
            // 判斷是否逾期（增加容錯時間，避免時差問題）
            const timeDiffMinutes = (now - expected) / (1000 * 60);
            
            if (timeDiffMinutes > 30) { // 超過30分鐘才算逾期
                const overdueDays = Math.ceil((now - expected) / (1000 * 60 * 60 * 24));
                const overdueHours = Math.ceil((now - expected) / (1000 * 60 * 60));
                
                badge.className = 'badge bg-danger';
                if (overdueHours < 24) {
                    badge.textContent = `已逾期 ${overdueHours} 小時`;
                } else {
                    badge.textContent = `已逾期 ${overdueDays} 天`;
                }
            } else if (timeDiffMinutes > -30) { // 30分鐘內到期
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = '即將到期';
            } else {
                // 計算剩餘時間
                const remainingMinutes = Math.floor((expected - now) / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingDays = Math.floor(remainingHours / 24);
                
                if (remainingHours < 1) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingMinutes} 分鐘後到期`;
                } else if (remainingHours < 24) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingHours} 小時後到期`;
                } else if (remainingDays <= 1) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = '明日到期';
                } else if (remainingDays <= 3) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingDays} 天後到期`;
                } else {
                    badge.className = 'badge bg-success';
                    badge.textContent = `${remainingDays} 天後到期`;
                }
            }
        }
    });
    
    // 保留原有的借用天數計算邏輯（用於其他功能）
    const daysBadges = document.querySelectorAll('.days-badge');
    daysBadges.forEach(badge => {
        const rentalTime = badge.getAttribute('data-rental-time');
        if (rentalTime) {
            const rentalDate = new Date(rentalTime.replace(' ', 'T') + '+08:00');
            const now = new Date();
            const diffTime = Math.abs(now - rentalDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            badge.textContent = `${diffDays} 天`;
            
            // 根據天數設定顏色
            if (diffDays > 7) {
                badge.className = 'badge bg-danger';
            } else if (diffDays > 3) {
                badge.className = 'badge bg-warning';
            } else {
                badge.className = 'badge bg-info';
            }
        }
    });
    
    // 重設密碼模態對話框處理
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    resetPasswordModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const studentId = button.getAttribute('data-student-id');
        const userName = button.getAttribute('data-user-name');
        
        // 設定隱藏欄位和顯示資訊
        document.getElementById('modalUserId').value = userId;
        document.getElementById('userInfo').textContent = userName;
        document.getElementById('studentIdInfo').textContent = studentId;
        
        // 清除表單
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        document.getElementById('resetPasswordBtn').disabled = true;
        document.getElementById('passwordMismatch').style.display = 'none';
    });
    
    // 密碼確認檢查
    function validatePasswords() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        const resetBtn = document.getElementById('resetPasswordBtn');
        const mismatchMsg = document.getElementById('passwordMismatch');
        
        if (newPassword.length >= 4 && confirmPassword.length >= 4) {
            if (newPassword === confirmPassword) {
                resetBtn.disabled = false;
                mismatchMsg.style.display = 'none';
                document.getElementById('confirmNewPassword').classList.remove('is-invalid');
            } else {
                resetBtn.disabled = true;
                mismatchMsg.style.display = 'block';
                document.getElementById('confirmNewPassword').classList.add('is-invalid');
            }
        } else {
            resetBtn.disabled = true;
            mismatchMsg.style.display = 'none';
            document.getElementById('confirmNewPassword').classList.remove('is-invalid');
        }
    }
    
    document.getElementById('newPassword').addEventListener('input', validatePasswords);
    document.getElementById('confirmNewPassword').addEventListener('input', validatePasswords);
    
    // 刪除用戶模態對話框處理
    const deleteUserModal = document.getElementById('deleteUserModal');
    deleteUserModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const studentId = button.getAttribute('data-student-id');
        const userName = button.getAttribute('data-user-name');
        const className = button.getAttribute('data-class-name');
        const clubRole = button.getAttribute('data-club-role');
        
        // 設定顯示資訊
        document.getElementById('deleteUserName').textContent = userName;
        document.getElementById('deleteStudentId').textContent = studentId;
        document.getElementById('deleteClassName').textContent = className;
        document.getElementById('deleteClubRole').textContent = clubRole;
        
        // 設定刪除連結
        document.getElementById('confirmDeleteBtn').href = `/delete_user/${userId}`;
    });
});
</script>
{% endblock %}