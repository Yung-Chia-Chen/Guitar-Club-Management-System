{% extends "admin_base.html" %}

{% block title %}ç®¡ç†ä»‹é¢ - å‰ä»–ç¤¾ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<style>
/* è‡ªè¨‚ç§Ÿå€Ÿè¨˜éŒ„é¡è‰² - æ·±è‰²èƒŒæ™¯ */
.rental-record {
    background-color: #762E1A !important; 
    color: white !important; /* ç™½è‰²æ–‡å­— */
}

/* ç¢ºä¿ç§Ÿå€Ÿè¨˜éŒ„ä¸­çš„ badge åœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¯è¦‹ */
.rental-record .badge {
    border: 1px solid rgba(255,255,255,0.3);
}

/* å™¨æåœ–ç‰‡æ¨£å¼ */
.equipment-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.equipment-image-placeholder {
    width: 50px;
    height: 50px;
    background-color: #f8f9fa;
    border: 1px dashed #ddd;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 12px;
}

.image-upload-preview {
    max-width: 150px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-top: 10px;
}
</style>

<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog"></i> ç®¡ç†ä»‹é¢</h2>
        
        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>ç¸½æœƒå“¡æ•¸</h5>
                        <h3>{{ members|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>æœªæ­¸é‚„å™¨æ</h5>
                        <h3>{{ unreturned|sum(attribute=4) }}</h3>
                        <small>{{ unreturned|length }} å€‹é …ç›®</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light text-dark">
                    <div class="card-body">
                        <h5>ç¸½ç§Ÿå€Ÿæ¬¡æ•¸</h5>
                        <h3>{{ all_rentals|length }}</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å°èˆªæ¨™ç±¤ -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                    <i class="fas fa-boxes"></i> å™¨æåº«å­˜
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="unreturned-tab" data-bs-toggle="tab" data-bs-target="#unreturned" type="button" role="tab">
                    <i class="fas fa-exclamation-triangle"></i> æœªæ­¸é‚„å™¨æ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
                    <i class="fas fa-users"></i> æœƒå“¡ç®¡ç†
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">
                    <i class="fas fa-history"></i> ç§Ÿå€Ÿè¨˜éŒ„
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="adminTabContent">
            <!-- å™¨æåº«å­˜ -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <div class="row">
                    <!-- åº«å­˜ç‹€æ³ -->
                    <div class="col-lg-8">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-boxes"></i> å™¨æåº«å­˜ç‹€æ³</h5>
                            </div>
                            <div class="card-body">
                                {% if equipment_status %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>åœ–ç‰‡</th>
                                                <th>å™¨æé¡å‹</th>
                                                <th>å‹è™Ÿ</th>
                                                <th>ç¸½æ•¸é‡</th>
                                                <th>å¯å€Ÿæ•¸é‡</th>
                                                <th>å·²å€Ÿå‡º</th>
                                                <th>ç‹€æ…‹</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in equipment_status %}
                                            <tr>
                                                <td>
                                                    {% if item[7] %}
                                                        <img src="{{ item[7] }}" class="equipment-image" 
                                                             alt="{{ item[2] }}" 
                                                             onclick="showImageModal('{{ item[6] or item[7] }}', '{{ item[2] }}')"
                                                             style="cursor: pointer;"
                                                             onerror="this.parentElement.innerHTML='<div class=equipment-image-placeholder>ç„¡åœ–ç‰‡</div>'">
                                                    {% else %}
                                                        <div class="equipment-image-placeholder">ç„¡åœ–ç‰‡</div>
                                                    {% endif %}
                                                </td>
                                                <td>{{ item[1] }}</td>
                                                <td>{{ item[2] }}</td>
                                                <td>
                                                    <form method="POST" action="{{ url_for('update_equipment') }}" class="d-inline" enctype="multipart/form-data">
                                                        <input type="hidden" name="equipment_id" value="{{ item[0] }}">
                                                        <div class="input-group input-group-sm" style="width: 120px;">
                                                            <input type="number" class="form-control" name="total_quantity" 
                                                                   value="{{ item[3] }}" min="1" max="99">
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                                    onclick="toggleImageUpload({{ item[0] }})" title="ä¸Šå‚³åœ–ç‰‡">
                                                                <i class="fas fa-camera"></i>
                                                            </button>
                                                            <button type="submit" class="btn btn-outline-primary btn-sm" 
                                                                    onclick="return confirm('ç¢ºå®šè¦ä¿®æ”¹æ•¸é‡å—ï¼Ÿ')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        </div>
                                                        <div id="imageUpload{{ item[0] }}" class="mt-2" style="display: none;">
                                                            <input type="file" class="form-control form-control-sm" 
                                                                   name="equipment_image" accept="image/*"
                                                                   onchange="previewImage(this, {{ item[0] }})">
                                                            <div id="imagePreview{{ item[0] }}"></div>
                                                        </div>
                                                    </form>
                                                </td>
                                                <td>{{ item[4] }}</td>
                                                <td>{{ item[5] }}</td>
                                                <td>
                                                    {% if item[4] == 0 %}
                                                        <span class="badge bg-danger">å·²å€Ÿå®Œ</span>
                                                    {% elif item[4] <= item[3] * 0.3 %}
                                                        <span class="badge bg-warning">åº«å­˜ä¸è¶³</span>
                                                    {% else %}
                                                        <span class="badge bg-success">å……è¶³</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{{ url_for('delete_equipment', equipment_id=item[0]) }}" 
                                                       class="btn btn-outline-danger btn-sm" 
                                                       onclick="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å™¨æå—ï¼Ÿå¦‚æœ‰æœªæ­¸é‚„è¨˜éŒ„å°‡ç„¡æ³•åˆªé™¤ã€‚')">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted">æš«ç„¡å™¨æè³‡æ–™</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–°å¢å™¨æ -->
                    <div class="col-lg-4">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus"></i> æ–°å¢å™¨æ</h6>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('add_equipment') }}" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="category" class="form-label">å™¨æé¡å‹</label>
                                        <input type="text" class="form-control" id="category" name="category" 
                                               placeholder="ä¾‹ï¼šæ’é›»å‰ä»–" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="model" class="form-label">å‹è™Ÿ</label>
                                        <input type="text" class="form-control" id="model" name="model" 
                                               placeholder="ä¾‹ï¼šFender Telecaster" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="total_quantity" class="form-label">æ•¸é‡</label>
                                        <input type="number" class="form-control" id="total_quantity" name="total_quantity" 
                                               min="1" max="99" value="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="equipment_image" class="form-label">å™¨æåœ–ç‰‡</label>
                                        <input type="file" class="form-control" id="equipment_image" name="equipment_image" 
                                               accept="image/*" onchange="previewNewImage(this)">
                                        <div class="form-text">æ”¯æ´ JPG, PNG æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 5MB</div>
                                        <div id="newImagePreview"></div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> æ–°å¢å™¨æ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œèªªæ˜ -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> æ“ä½œèªªæ˜</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-edit text-primary"></i> ç›´æ¥ä¿®æ”¹ç¸½æ•¸é‡ä¸¦é»æ“Š âœ“</li>
                                    <li><i class="fas fa-camera text-info"></i> é»æ“Šç›¸æ©Ÿåœ–ç¤ºä¸Šå‚³åœ–ç‰‡</li>
                                    <li><i class="fas fa-plus text-success"></i> å³å´è¡¨å–®æ–°å¢å™¨æ</li>
                                    <li><i class="fas fa-image text-warning"></i> é»æ“Šåœ–ç‰‡å¯æ”¾å¤§æª¢è¦–</li>
                                    <li><i class="fas fa-trash text-danger"></i> åˆªé™¤å™¨æï¼ˆéœ€ç„¡å€Ÿç”¨è¨˜éŒ„ï¼‰</li>
                                    <li><i class="fas fa-exclamation-triangle text-warning"></i> ç¸½æ•¸é‡ä¸èƒ½å°æ–¼å·²å€Ÿå‡ºæ•¸é‡</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æœªæ­¸é‚„å™¨æ -->
            <div class="tab-pane fade" id="unreturned" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle text-warning"></i> æœªæ­¸é‚„å™¨æ</h5>
                        <span class="badge bg-warning text-dark">{{ unreturned|length }}  å€‹é …ç›®</span>
                    </div>
                    <div class="card-body">
                        {% if unreturned %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>å€Ÿç”¨äºº</th>
                                        <th>å­¸è™Ÿ</th>
                                        <th>å™¨æé¡å‹</th>
                                        <th>å‹è™Ÿ</th>
                                        <th>æœªæ­¸é‚„æ•¸é‡</th>
                                        <th>æœ€æ—©ç§Ÿå€Ÿæ™‚é–“</th>
                                        <th>é è¨ˆæ­¸é‚„æ—¥æœŸ</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in unreturned %}
                                    <tr>
                                        <td>{{ item[0] }}</td>
                                        <td>{{ item[1] }}</td>
                                        <td>{{ item[2] }}</td>
                                        <td>{{ item[3] }}</td>
                                        <td>
                                            <span class="badge bg-warning text-dark">{{ item[4] }} ä»¶</span>
                                        </td>
                                        <td>{{ item[5] }}</td>
                                        <td>
                                            {% if item[8] %}
                                                {{ item[8] }}
                                                {% if item[7] %}
                                                    <small class="text-muted d-block">({{ item[7] }} å¤©)</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">æœªè¨­å®š</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item[8] %}
                                                <span class="badge overdue-badge" 
                                                      data-expected-date="{{ item[8] }}" 
                                                      data-rental-time="{{ item[5] }}">è¨ˆç®—ä¸­...</span>
                                            {% else %}
                                                <span class="badge bg-secondary">ç„¡é æœŸæ—¥æœŸ</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">ç›®å‰æ²’æœ‰æœªæ­¸é‚„çš„å™¨æ</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- æœƒå“¡ç®¡ç† -->
            <div class="tab-pane fade" id="members" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users"></i> è¨»å†Šæœƒå“¡åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        {% if members %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>å­¸è™Ÿ</th>
                                        <th>å§“å</th>
                                        <th>ç­ç´š</th>
                                        <th>ç¤¾åœ˜èº«åˆ†</th>
                                        <th>è¨»å†Šæ™‚é–“</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member in members %}
                                    <tr>
                                        <td>{{ member[1] }}</td>
                                        <td>{{ member[2] }}</td>
                                        <td>{{ member[3] }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ member[4] }}</span>
                                        </td>
                                        <td>{{ member[5] }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal"
                                                        data-user-id="{{ member[0] }}"
                                                        data-student-id="{{ member[1] }}"
                                                        data-user-name="{{ member[2] }}">
                                                    <i class="fas fa-key"></i> é‡è¨­å¯†ç¢¼
                                                </button>
                                                <span style="display:inline-block; width:32px;"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteUserModal"
                                                        data-user-id="{{ member[0] }}"
                                                        data-student-id="{{ member[1] }}"
                                                        data-user-name="{{ member[2] }}"
                                                        data-class-name="{{ member[3] }}"
                                                        data-club-role="{{ member[4] }}">
                                                    <i class="fas fa-trash"></i> åˆªé™¤
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">æš«ç„¡è¨»å†Šæœƒå“¡</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- ç§Ÿå€Ÿè¨˜éŒ„ -->
            <div class="tab-pane fade" id="records" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> æ‰€æœ‰ç§Ÿå€Ÿè¨˜éŒ„</h5>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('export_excel') }}" class="btn btn-success btn-sm">
                                <i class="fas fa-file-excel"></i> åŒ¯å‡º Excel
                            </a>
                            <button type="button" class="btn btn-danger btn-sm ms-2" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#clearRecordsModal">
                                <i class="fas fa-trash-alt"></i> æ¸…ç©ºè¨˜éŒ„
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if all_rentals %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>è¨˜éŒ„èªªæ˜ï¼š</strong>æ·±è‰²èƒŒæ™¯ç‚ºåˆå§‹ç§Ÿå€Ÿè¨˜éŒ„ï¼Œç™½è‰²èƒŒæ™¯ç‚ºæ­¸é‚„è¨˜éŒ„ã€‚
                            æ¸…ç©ºè¨˜éŒ„åŠŸèƒ½æœƒåˆªé™¤æ‰€æœ‰ç§Ÿå€Ÿæ­·å²ä¸¦é‡ç½®å™¨æåº«å­˜ã€‚
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>å€Ÿç”¨äºº</th>
                                        <th>å­¸è™Ÿ</th>
                                        <th>å™¨æé¡å‹</th>
                                        <th>å‹è™Ÿ</th>
                                        <th>æ•¸é‡</th>
                                        <th>ç§Ÿå€Ÿæ™‚é–“</th>
                                        <th>æ­¸é‚„æ™‚é–“</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in all_rentals %}
                                    <tr {% if record[7] == 'rental' %}class="rental-record"{% endif %}>
                                        <td>{% if record[7] == 'rental' %}
                                            {{ record[0] }}
                                            {% endif %}
                                        </td>
                                        <td>{% if record[7] == 'rental' %}
                                            {{ record[1] }}
                                            {% endif %}
                                        </td>
                                        <td>{{ record[2] }}</td>
                                        <td>{{ record[3] }}</td>
                                        <td>{{ record[6] }} ä»¶</td>
                                        <td>{{ record[4] }}</td>
                                        <td>
                                            {% if record[7] == 'rental' %}
                                                åˆå§‹ç§Ÿå€Ÿ
                                            {% elif record[5] %}
                                                {{ record[5] }}
                                            {% else %}
                                                æœªæ­¸é‚„
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record[7] == 'rental' %}
                                                {% if record[9] > 0 %}
                                                    <span class="badge bg-success">ç§Ÿå€Ÿä¸­ (å…±{{ record[8] }}ä»¶)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">å·²å…¨éƒ¨æ­¸é‚„</span>
                                                {% endif %}
                                            {% elif record[9] > 0 %}
                                                <span class="badge bg-danger">å‰©é¤˜{{ record[9] }}ä»¶æœªé‚„</span>
                                            {% else %}
                                                
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">æš«ç„¡ç§Ÿå€Ÿè¨˜éŒ„</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ¸…ç©ºç§Ÿå€Ÿè¨˜éŒ„ç¢ºèªå°è©±æ¡† -->
<div class="modal fade" id="clearRecordsModal" tabindex="-1" aria-labelledby="clearRecordsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearRecordsModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å±éšªæ“ä½œï¼šæ¸…ç©ºæ‰€æœ‰ç§Ÿå€Ÿè¨˜éŒ„
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('clear_all_records') }}">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-skull-crossbones"></i>
                        <strong>âš ï¸ å±éšªæ“ä½œ âš ï¸</strong><br>
                        æ­¤æ“ä½œå°‡æœƒ<strong>æ°¸ä¹…åˆªé™¤</strong>æ‰€æœ‰ç§Ÿå€Ÿè¨˜éŒ„ï¼Œç„¡æ³•å¾©åŸï¼
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">ğŸ“‹ æ­¤æ“ä½œå°‡æœƒï¼š</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li>âŒ <strong>åˆªé™¤æ‰€æœ‰ç§Ÿå€Ÿè¨˜éŒ„</strong> (åŒ…å«æ­·å²è¨˜éŒ„)</li>
                                <li>âŒ <strong>åˆªé™¤æ‰€æœ‰æ­¸é‚„è¨˜éŒ„</strong></li>
                                <li>ğŸ”„ <strong>é‡ç½®æ‰€æœ‰å™¨æåº«å­˜</strong> (è¨­ç‚ºæœ€å¤§å¯å€Ÿæ•¸é‡)</li>
                                <li>âœ… <strong>ä¿ç•™æ‰€æœ‰ç”¨æˆ¶è³‡æ–™</strong></li>
                                <li>âœ… <strong>ä¿ç•™æ‰€æœ‰å™¨æè³‡æ–™</strong></li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label for="confirmationText" class="form-label">
                            <strong>å®‰å…¨ç¢ºèªï¼š</strong>è«‹è¼¸å…¥ã€Œ<span class="text-danger">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</span>ã€ä¾†ç¢ºèªæ“ä½œ
                        </label>
                        <input type="text" class="form-control" name="confirmation_text" id="confirmationText" 
                               placeholder="è«‹å®Œå…¨æŒ‰ç…§è¦æ±‚è¼¸å…¥ç¢ºèªæ–‡å­—" required>
                        <div class="form-text">
                            å¿…é ˆå®Œå…¨ä¸€è‡´æ‰èƒ½åŸ·è¡Œæ“ä½œï¼Œå¤§å°å¯«å’Œæ¨™é»ç¬¦è™Ÿéƒ½è¦æ­£ç¢º
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="finalConfirmation" required>
                        <label class="form-check-label" for="finalConfirmation">
                            æˆ‘äº†è§£æ­¤æ“ä½œçš„å¾Œæœï¼Œä¸¦ç¢ºèªè¦åŸ·è¡Œæ¸…ç©ºè¨˜éŒ„æ“ä½œ
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-danger" id="clearRecordsBtn" disabled>
                        <i class="fas fa-trash-alt"></i> ç¢ºèªæ¸…ç©ºæ‰€æœ‰è¨˜éŒ„
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// æ¸…ç©ºè¨˜éŒ„ç¢ºèªé‚è¼¯
document.addEventListener('DOMContentLoaded', function() {
    const confirmationText = document.getElementById('confirmationText');
    const finalConfirmation = document.getElementById('finalConfirmation');
    const clearBtn = document.getElementById('clearRecordsBtn');
    
    function validateClearForm() {
        const textCorrect = confirmationText.value === 'æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„';
        const checkboxChecked = finalConfirmation.checked;
        
        clearBtn.disabled = !(textCorrect && checkboxChecked);
        
        // è¦–è¦ºå›é¥‹
        if (confirmationText.value && !textCorrect) {
            confirmationText.classList.add('is-invalid');
        } else {
            confirmationText.classList.remove('is-invalid');
        }
    }
    
    confirmationText.addEventListener('input', validateClearForm);
    finalConfirmation.addEventListener('change', validateClearForm);
    
    // é‡ç½®è¡¨å–®ç•¶æ¨¡æ…‹å°è©±æ¡†é—œé–‰æ™‚
    const clearModal = document.getElementById('clearRecordsModal');
    clearModal.addEventListener('hidden.bs.modal', function() {
        confirmationText.value = '';
        finalConfirmation.checked = false;
        confirmationText.classList.remove('is-invalid');
        clearBtn.disabled = true;
    });
});
</script>

<!-- åœ–ç‰‡æª¢è¦–æ¨¡æ…‹å°è©±æ¡† -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">å™¨æåœ–ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="å™¨æåœ–ç‰‡" style="max-height: 500px;">
            </div>
        </div>
    </div>
</div>

<!-- é‡è¨­å¯†ç¢¼æ¨¡æ…‹å°è©±æ¡† -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetPasswordModalLabel">
                    <i class="fas fa-key"></i> é‡è¨­ç”¨æˆ¶å¯†ç¢¼
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('reset_user_password') }}">
                <div class="modal-body">
                    <input type="hidden" name="user_id" id="modalUserId">
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>æ³¨æ„ï¼š</strong>é‡è¨­å¯†ç¢¼å¾Œï¼Œè©²ç”¨æˆ¶éœ€è¦ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ç”¨æˆ¶è³‡è¨Š</label>
                        <div class="card">
                            <div class="card-body">
                                <h6 id="userInfo" class="mb-1"></h6>
                                <small class="text-muted">å­¸è™Ÿï¼š<span id="studentIdInfo"></span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">æ–°å¯†ç¢¼</label>
                        <input type="password" class="form-control" name="new_password" id="newPassword" 
                               placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" minlength="4" required>
                        <div class="form-text">å¯†ç¢¼é•·åº¦è‡³å°‘4å€‹å­—å…ƒ</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="confirmNewPassword" 
                               placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" minlength="4" required>
                        <div class="invalid-feedback" id="passwordMismatch" style="display: none;">
                            å¯†ç¢¼ç¢ºèªä¸ç¬¦
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-warning" id="resetPasswordBtn" disabled>
                        <i class="fas fa-key"></i> ç¢ºèªé‡è¨­å¯†ç¢¼
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- åˆªé™¤ç”¨æˆ¶æ¨¡æ…‹å°è©±æ¡† -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> åˆªé™¤ç¤¾å“¡
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>è­¦å‘Šï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼</strong>
                </div>
                
                <p>æ‚¨ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹ç¤¾å“¡å—ï¼Ÿ</p>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-2" id="deleteUserName"></h6>
                        <div class="row">
                            <div class="col-sm-4"><strong>å­¸è™Ÿï¼š</strong></div>
                            <div class="col-sm-8" id="deleteStudentId"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>ç­ç´šï¼š</strong></div>
                            <div class="col-sm-8" id="deleteClassName"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>ç¤¾åœ˜èº«åˆ†ï¼š</strong></div>
                            <div class="col-sm-8"><span class="badge bg-info" id="deleteClubRole"></span></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>æ³¨æ„äº‹é …ï¼š</h6>
                    <ul class="small text-muted">
                        <li>å¦‚æœè©²ç¤¾å“¡æœ‰æœªæ­¸é‚„çš„å™¨æï¼Œå°‡ç„¡æ³•åˆªé™¤</li>
                        <li>åˆªé™¤å¾Œè©²ç¤¾å“¡çš„æ­·å²ç§Ÿå€Ÿè¨˜éŒ„æœƒä¿ç•™ä½œç‚ºè¿½è¹¤</li>
                        <li>è©²ç¤¾å“¡å°‡ç„¡æ³•å†ç™»å…¥ç³»çµ±</li>
                        <li>æ­¤æ“ä½œç„¡æ³•å¾©åŸ</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <a id="confirmDeleteBtn" href="#" class="btn btn-danger">
                    <i class="fas fa-trash"></i> ç¢ºèªåˆªé™¤
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// åœ–ç‰‡ç›¸é—œåŠŸèƒ½
function showImageModal(imageUrl, equipmentName) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModalLabel').textContent = `å™¨æåœ–ç‰‡ - ${equipmentName}`;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function toggleImageUpload(equipmentId) {
    const uploadDiv = document.getElementById(`imageUpload${equipmentId}`);
    if (uploadDiv.style.display === 'none') {
        uploadDiv.style.display = 'block';
    } else {
        uploadDiv.style.display = 'none';
    }
}

function previewImage(input, equipmentId) {
    const previewDiv = document.getElementById(`imagePreview${equipmentId}`);
    previewDiv.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // æª¢æŸ¥æª”æ¡ˆå¤§å° (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
            input.value = '';
            return;
        }
        
        // æª¢æŸ¥æª”æ¡ˆé¡å‹
        if (!file.type.startsWith('image/')) {
            alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-upload-preview';
            previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewNewImage(input) {
    const previewDiv = document.getElementById('newImagePreview');
    previewDiv.innerHTML = '';
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // æª¢æŸ¥æª”æ¡ˆå¤§å° (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
            input.value = '';
            return;
        }
        
        // æª¢æŸ¥æª”æ¡ˆé¡å‹
        if (!file.type.startsWith('image/')) {
            alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-upload-preview';
            previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

// è¨ˆç®—å€Ÿç”¨å¤©æ•¸å’Œé€¾æœŸç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    // è™•ç†é€¾æœŸç‹€æ…‹è¨ˆç®—
    const overdueBadges = document.querySelectorAll('.overdue-badge');
    overdueBadges.forEach(badge => {
        const expectedDate = badge.getAttribute('data-expected-date');
        const rentalTime = badge.getAttribute('data-rental-time');
        
        if (expectedDate) {
            // ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ™‚é–“è§£æ
            const now = new Date();
            
            // è§£æé è¨ˆæ­¸é‚„æ™‚é–“ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MMï¼‰
            let expected;
            if (expectedDate.includes(' ')) {
                // åŒ…å«æ™‚é–“çš„æ ¼å¼
                expected = new Date(expectedDate.replace(' ', 'T') + ':00+08:00'); // æ˜ç¢ºæŒ‡å®šå°ç£æ™‚å€
            } else {
                // åªæœ‰æ—¥æœŸçš„æ ¼å¼ï¼Œè¨­ç‚ºç•¶å¤©23:59
                expected = new Date(expectedDate + 'T23:59:59+08:00');
            }
            
            // è§£æç§Ÿå€Ÿæ™‚é–“
            const rental = new Date(rentalTime.replace(' ', 'T') + '+08:00');
            
            // è¨ˆç®—å·²å€Ÿç”¨æ™‚é–“ï¼ˆä»¥å°æ™‚ç‚ºå–®ä½ï¼Œæ›´ç²¾ç¢ºï¼‰
            const borrowedHours = Math.floor((now - rental) / (1000 * 60 * 60));
            const borrowedDays = Math.floor(borrowedHours / 24);
            
            console.log('Debug info:', {
                now: now.toISOString(),
                expected: expected.toISOString(), 
                rental: rental.toISOString(),
                borrowedHours: borrowedHours,
                timeDiff: now - expected
            });
            
            // åˆ¤æ–·æ˜¯å¦é€¾æœŸï¼ˆå¢åŠ å®¹éŒ¯æ™‚é–“ï¼Œé¿å…æ™‚å·®å•é¡Œï¼‰
            const timeDiffMinutes = (now - expected) / (1000 * 60);
            
            if (timeDiffMinutes > 30) { // è¶…é30åˆ†é˜æ‰ç®—é€¾æœŸ
                const overdueDays = Math.ceil((now - expected) / (1000 * 60 * 60 * 24));
                const overdueHours = Math.ceil((now - expected) / (1000 * 60 * 60));
                
                badge.className = 'badge bg-danger';
                if (overdueHours < 24) {
                    badge.textContent = `å·²é€¾æœŸ ${overdueHours} å°æ™‚`;
                } else {
                    badge.textContent = `å·²é€¾æœŸ ${overdueDays} å¤©`;
                }
            } else if (timeDiffMinutes > -30) { // 30åˆ†é˜å…§åˆ°æœŸ
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = 'å³å°‡åˆ°æœŸ';
            } else {
                // è¨ˆç®—å‰©é¤˜æ™‚é–“
                const remainingMinutes = Math.floor((expected - now) / (1000 * 60));
                const remainingHours = Math.floor(remainingMinutes / 60);
                const remainingDays = Math.floor(remainingHours / 24);
                
                if (remainingHours < 1) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingMinutes} åˆ†é˜å¾Œåˆ°æœŸ`;
                } else if (remainingHours < 24) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingHours} å°æ™‚å¾Œåˆ°æœŸ`;
                } else if (remainingDays <= 1) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = 'æ˜æ—¥åˆ°æœŸ';
                } else if (remainingDays <= 3) {
                    badge.className = 'badge bg-warning text-dark';
                    badge.textContent = `${remainingDays} å¤©å¾Œåˆ°æœŸ`;
                } else {
                    badge.className = 'badge bg-success';
                    badge.textContent = `${remainingDays} å¤©å¾Œåˆ°æœŸ`;
                }
            }
        }
    });
    
    // ä¿ç•™åŸæœ‰çš„å€Ÿç”¨å¤©æ•¸è¨ˆç®—é‚è¼¯ï¼ˆç”¨æ–¼å…¶ä»–åŠŸèƒ½ï¼‰
    const daysBadges = document.querySelectorAll('.days-badge');
    daysBadges.forEach(badge => {
        const rentalTime = badge.getAttribute('data-rental-time');
        if (rentalTime) {
            const rentalDate = new Date(rentalTime.replace(' ', 'T') + '+08:00');
            const now = new Date();
            const diffTime = Math.abs(now - rentalDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            badge.textContent = `${diffDays} å¤©`;
            
            // æ ¹æ“šå¤©æ•¸è¨­å®šé¡è‰²
            if (diffDays > 7) {
                badge.className = 'badge bg-danger';
            } else if (diffDays > 3) {
                badge.className = 'badge bg-warning';
            } else {
                badge.className = 'badge bg-info';
            }
        }
    });
    
    // é‡è¨­å¯†ç¢¼æ¨¡æ…‹å°è©±æ¡†è™•ç†
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    resetPasswordModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const studentId = button.getAttribute('data-student-id');
        const userName = button.getAttribute('data-user-name');
        
        // è¨­å®šéš±è—æ¬„ä½å’Œé¡¯ç¤ºè³‡è¨Š
        document.getElementById('modalUserId').value = userId;
        document.getElementById('userInfo').textContent = userName;
        document.getElementById('studentIdInfo').textContent = studentId;
        
        // æ¸…é™¤è¡¨å–®
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        document.getElementById('resetPasswordBtn').disabled = true;
        document.getElementById('passwordMismatch').style.display = 'none';
    });
    
    // å¯†ç¢¼ç¢ºèªæª¢æŸ¥
    function validatePasswords() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        const resetBtn = document.getElementById('resetPasswordBtn');
        const mismatchMsg = document.getElementById('passwordMismatch');
        
        if (newPassword.length >= 4 && confirmPassword.length >= 4) {
            if (newPassword === confirmPassword) {
                resetBtn.disabled = false;
                mismatchMsg.style.display = 'none';
                document.getElementById('confirmNewPassword').classList.remove('is-invalid');
            } else {
                resetBtn.disabled = true;
                mismatchMsg.style.display = 'block';
                document.getElementById('confirmNewPassword').classList.add('is-invalid');
            }
        } else {
            resetBtn.disabled = true;
            mismatchMsg.style.display = 'none';
            document.getElementById('confirmNewPassword').classList.remove('is-invalid');
        }
    }
    
    document.getElementById('newPassword').addEventListener('input', validatePasswords);
    document.getElementById('confirmNewPassword').addEventListener('input', validatePasswords);
    
    // åˆªé™¤ç”¨æˆ¶æ¨¡æ…‹å°è©±æ¡†è™•ç†
    const deleteUserModal = document.getElementById('deleteUserModal');
    deleteUserModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const userId = button.getAttribute('data-user-id');
        const studentId = button.getAttribute('data-student-id');
        const userName = button.getAttribute('data-user-name');
        const className = button.getAttribute('data-class-name');
        const clubRole = button.getAttribute('data-club-role');
        
        // è¨­å®šé¡¯ç¤ºè³‡è¨Š
        document.getElementById('deleteUserName').textContent = userName;
        document.getElementById('deleteStudentId').textContent = studentId;
        document.getElementById('deleteClassName').textContent = className;
        document.getElementById('deleteClubRole').textContent = clubRole;
        
        // è¨­å®šåˆªé™¤é€£çµ
        document.getElementById('confirmDeleteBtn').href = `/delete_user/${userId}`;
    });
});
</script>
{% endblock %}